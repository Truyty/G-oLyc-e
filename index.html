-- Supprime les anciennes politiques et fonctions pour éviter les erreurs
DROP POLICY IF EXISTS "Users can manage their own friend list." ON public.friends;
DROP POLICY IF EXISTS "Users can view their own friend list." ON public.friends;
DROP POLICY IF EXISTS "Users can insert their own friend entry." ON public.friends;
DROP POLICY IF EXISTS "Users can delete their own friend entry." ON public.friends;
DROP FUNCTION IF EXISTS add_friend(uuid);
DROP FUNCTION IF EXISTS remove_friend(uuid);

-- Politiques de Sécurité (RLS) pour la table 'friends'
-- 1. Les utilisateurs peuvent voir leurs propres relations d'amitié.
CREATE POLICY "Users can view their own friend list."
ON public.friends FOR SELECT
USING (auth.uid() = user_id);

-- 2. Les utilisateurs ne peuvent insérer que leur côté de la relation d'amitié.
CREATE POLICY "Users can insert their own friend entry."
ON public.friends FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- 3. Les utilisateurs ne peuvent supprimer que leur côté de la relation d'amitié.
CREATE POLICY "Users can delete their own friend entry."
ON public.friends FOR DELETE
USING (auth.uid() = user_id);

-- Fonction pour créer une amitié réciproque de manière sécurisée
create or replace function add_friend(friend_uuid uuid)
returns void
language plpgsql
security definer set search_path = public
as $$
begin
-- Insère la relation de l'utilisateur actuel vers l'ami
insert into public.friends(user_id, friend_id)
values (auth.uid(), friend_uuid);

-- Insère la relation réciproque de l'ami vers l'utilisateur actuel
insert into public.friends(user_id, friend_id)
values (friend_uuid, auth.uid());
end;
$$;

-- Fonction pour supprimer une amitié réciproque de manière sécurisée
create or replace function remove_friend(friend_uuid uuid)
returns void
language plpgsql
security definer set search_path = public
as $$
begin
-- Supprime la relation de l'utilisateur actuel vers l'ami
delete from public.friends
where user_id = auth.uid() and friend_id = friend_uuid;

-- Supprime la relation réciproque de l'ami vers l'utilisateur actuel
delete from public.friends
where user_id = friend_uuid and friend_id = auth.uid();
end;
$$;

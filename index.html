<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GéoLycée</title>
    
    <!-- Librairies externes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

    <style>
        /* CSS du fichier style.css intégré ici */
        body, html {
            height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        #map { height: 100%; width: 100%; background-color: #f0f0f0; }
        .leaflet-tooltip.name-tooltip {
            background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); border: none;
            border-radius: 8px; padding: 4px 10px; font-weight: 600; color: #333;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            70% { transform: scale(3); opacity: 0; }
            100% { transform: scale(3); opacity: 0; }
        }
        .pulse-ring {
            position: absolute; top: 50%; left: 50%; width: 24px; height: 24px; border-radius: 50%;
            background-color: #3B82F6; animation: pulse 2s ease-out infinite; z-index: -1;
            transform: translate(-50%, -50%);
        }
        .switch { position: relative; display: inline-block; width: 48px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3B82F6; }
        input:checked + .slider:before { transform: translateX(20px); }
        .bottom-nav { position: absolute; bottom: 0; left: 0; right: 0; background-color: white; border-top: 1px solid #e5e7eb; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05); z-index: 1000; }
        .nav-content { display: flex; justify-content: space-around; align-items: center; max-width: 448px; margin: auto; padding: 0.5rem 1rem; }
        .menu-btn-container { display: flex; flex-direction: column; align-items: center; padding: 0.25rem; border-radius: 12px; transition: all 0.2s ease-in-out; color: #4B5563; width: 72px; height: 64px; justify-content: center; }
        .menu-btn-container.active-menu { color: #4338CA; }
        .menu-btn-container.active-menu .menu-icon { transform: scale(1.2) translateY(-2px); background-color: #E0E7FF; }
        .menu-btn-container span { font-size: 0.75rem; margin-top: 0.3rem; font-weight: 600; transition: opacity 0.2s ease-in-out; }
        .menu-btn-container:not(.active-menu) span { opacity: 0; }
        .menu-icon { padding: 0.75rem; border-radius: 9999px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1500; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        #qr-scanner-container { overflow: hidden; border-radius: 1rem; }
    </style>
</head>
<body class="bg-gray-100 antialiased">
    
    <div id="loader" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[2000]">
        <svg class="animate-spin h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p class="mt-4 text-gray-600">Chargement de GéoLycée...</p>
    </div>

    <!-- Écran d'Authentification -->
    <div id="auth-view" class="h-full w-full flex items-center justify-center p-4 bg-gray-50 hidden">
        <div class="w-full max-w-md">
            <!-- Formulaire d'Inscription -->
            <div id="signup-container">
                <div class="bg-white p-8 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Créer un compte</h2>
                    <form id="signup-form">
                        <input id="signup-firstname" type="text" placeholder="Prénom" required class="w-full p-3 mb-4 border rounded-lg" autocomplete="given-name">
                        <input id="signup-lastname" type="text" placeholder="Nom de famille" required class="w-full p-3 mb-4 border rounded-lg" autocomplete="family-name">
                        <div class="relative">
                            <input id="signup-password" type="password" placeholder="Mot de passe" required class="w-full p-3 mb-4 border rounded-lg pr-10" autocomplete="new-password">
                            <button type="button" id="toggle-signup-password" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600" style="top: -0.5rem;">
                                <svg class="w-5 h-5 eye-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                <svg class="w-5 h-5 eye-slashed-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>
                            </button>
                        </div>
                        <div id="signup-status" class="mb-4 text-sm font-semibold text-center"></div>
                        <button id="signup-btn" type="submit" class="w-full bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600">Créer un compte</button>
                    </form>
                </div>
                <p class="text-center text-gray-600 mt-4">
                    Déjà un compte ? <button id="show-login-btn" class="font-semibold text-blue-600 hover:underline">Se connecter</button>
                </p>
            </div>

            <!-- Formulaire de Connexion -->
            <div id="login-container" class="hidden">
                <div class="bg-white p-8 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Se connecter</h2>
                    <form id="login-form">
                        <input id="login-firstname" type="text" placeholder="Prénom" required class="w-full p-3 mb-4 border rounded-lg" autocomplete="given-name">
                        <input id="login-lastname" type="text" placeholder="Nom de famille" required class="w-full p-3 mb-4 border rounded-lg" autocomplete="family-name">
                        <div class="relative">
                           <input id="login-password" type="password" placeholder="Mot de passe" required class="w-full p-3 mb-4 border rounded-lg pr-10" autocomplete="current-password">
                           <button type="button" id="toggle-login-password" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600" style="top: -0.5rem;">
                               <svg class="w-5 h-5 eye-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                               <svg class="w-5 h-5 eye-slashed-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>
                           </button>
                        </div>
                        <div id="login-status" class="mb-4 text-sm font-semibold text-center"></div>
                        <button id="login-btn" type="submit" class="w-full bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600">Se connecter</button>
                    </form>
                </div>
                <p class="text-center text-gray-600 mt-4">
                    Pas de compte ? <button id="show-signup-btn" class="font-semibold text-blue-600 hover:underline">Créer un compte</button>
                </p>
            </div>
        </div>
    </div>
    
    <div id="name-input-modal" class="modal-backdrop hidden">
        <div class="bg-white p-6 sm:p-8 rounded-2xl w-full max-w-sm shadow-2xl">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Finalisation de l'inscription</h2>
            <p class="text-gray-600 mb-6">Confirmez votre nom complet pour que vos amis puissent vous reconnaître.</p>
            <input id="name-input" type="text" placeholder="Votre nom complet..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
            <button id="save-name-btn" class="w-full bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600">Enregistrer</button>
        </div>
    </div>

    <!-- Modals (QR Code, Scanner, etc.) -->
    <div id="my-qr-code-modal" class="modal-backdrop hidden">
        <div class="bg-white p-6 sm:p-8 rounded-2xl text-center w-full max-w-xs shadow-2xl relative">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Votre QR Code</h2>
            <div id="qr-code-container" class="bg-gray-100 p-4 rounded-lg flex justify-center items-center"></div>
            <p class="text-sm text-gray-500 mt-4">Montrez ce code à vos amis pour qu'ils vous ajoutent.</p>
            <button id="close-qr-code-modal-btn" class="absolute -top-2 -right-2 bg-gray-200 rounded-full p-1.5 hover:bg-gray-300">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>

    <div id="qr-scanner-modal" class="modal-backdrop hidden">
        <div class="bg-white p-4 rounded-2xl text-center w-full max-w-sm shadow-2xl relative">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Scanner un ami</h2>
            <div id="qr-scanner-container" class="w-full" style="max-width: 400px;"></div>
             <button id="close-scanner-modal-btn" class="mt-4 bg-red-500 text-white px-6 py-2 rounded-lg font-bold">Annuler</button>
        </div>
    </div>
    
    <div id="confirm-delete-modal" class="modal-backdrop hidden">
        <div class="bg-white p-6 sm:p-8 rounded-2xl text-center w-full max-w-sm shadow-2xl relative">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Supprimer un ami</h2>
            <p class="text-gray-600 mb-6" id="confirm-delete-text">Êtes-vous sûr de vouloir supprimer cet ami ?</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="w-full bg-gray-200 text-gray-800 p-3 rounded-lg font-bold hover:bg-gray-300">Annuler</button>
                <button id="confirm-delete-btn" class="w-full bg-red-500 text-white p-3 rounded-lg font-bold hover:bg-red-600">Supprimer</button>
            </div>
        </div>
    </div>

    <div id="paste-id-modal" class="modal-backdrop hidden">
        <div class="bg-white p-6 sm:p-8 rounded-2xl text-center w-full max-w-sm shadow-2xl relative">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Ajouter par ID</h2>
            <p class="text-gray-600 mb-6">Collez l'ID de votre ami ci-dessous.</p>
            <input id="paste-id-input" type="text" placeholder="ID de l'ami..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4 text-center">
            <button id="add-friend-from-id-btn" class="w-full bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600">Ajouter</button>
            <button id="close-paste-id-modal-btn" class="absolute -top-2 -right-2 bg-gray-200 rounded-full p-1.5 hover:bg-gray-300">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>

    <div id="app-container" class="relative w-full h-full flex flex-col hidden">
        <header class="absolute top-0 inset-x-0 p-4 flex items-center justify-center z-[1000] pointer-events-none">
            <div class="bg-white/80 backdrop-blur-md px-6 py-3 rounded-full shadow-lg">
                <h1 class="text-xl font-bold text-gray-800 tracking-tight">GéoLycée</h1>
            </div>
        </header>
        
        <div id="status" class="hidden"></div>
        <div id="top-banner" class="absolute top-24 inset-x-0 mx-auto w-max bg-yellow-100 text-yellow-800 text-sm font-semibold px-4 py-2 rounded-full shadow-lg z-[1000] hidden"></div>

        <main class="flex-grow w-full h-full relative overflow-hidden">
            <div id="map-view" class="w-full h-full relative">
                <div id="map"></div>
                <!-- Bouton pour centrer la carte sur l'utilisateur -->
                <button id="center-map-btn" class="absolute bottom-24 right-4 z-[1000] bg-white p-3 rounded-full shadow-lg hover:bg-gray-100 transition">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12a3 3 0 116 0 3 3 0 01-6 0z"></path></svg>
                </button>
            </div>
            <div id="friends-view" class="w-full h-full bg-gray-50 p-6 pt-24 overflow-y-auto hidden">
                <div class="max-w-md mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Amis</h2>
                        <button id="edit-friends-btn" class="text-blue-600 font-semibold hover:text-blue-800">Modifier</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-8">
                         <button id="my-qr-code-btn" class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-center hover:bg-gray-50 transition flex flex-col items-center justify-center">
                             <svg class="w-8 h-8 text-blue-500 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 013.75 9.375v-4.5zM3.75 14.625c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5a1.875 1.875 0 01-1.875-1.875v-4.5zM13.5 4.875c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 0113.5 9.375v-4.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 15.75a.75.75 0 00.75.75h.008a.75.75 0 00.75-.75v-.008a.75.75 0 00-.75-.75h-.008a.75.75 0 00-.75.75v.008zM16.5 15.75a.75.75 0 00.75.75h.008a.75.75 0 00.75-.75v-.008a.75.75 0 00-.75-.75h-.008a.75.75 0 00-.75.75v.008zM18.75 15.75a.75.75 0 00.75.75h.008a.75.75 0 00.75-.75v-.008a.75.75 0 00-.75-.75h-.008a.75.75 0 00-.75.75v.008zM14.25 18a.75.75 0 00.75.75h.008a.75.75 0 00.75-.75v-.008a.75.75 0 00-.75-.75h-.008a.75.75 0 00-.75.75v.008zM16.5 18a.75.75 0 00.75.75h.008a.75.75 0 00.75-.75v-.008a.75.75 0 00-.75-.75h-.008a.75.75 0 00-.75.75v.008zM18.75 18a.75.75 0 00.75.75h.008a.75.75 0 00.75-.75v-.008a.75.75 0 00-.75-.75h-.008a.75.75 0 00-.75.75v.008zM14.25 20.25a.75.75 0 00.75.75h.008a.75.75 0 00.75-.75v-.008a.75.75 0 00-.75-.75h-.008a.75.75 0 00-.75.75v.008zM16.5 20.25a.75.75 0 00.75.75h.008a.75.75 0 00.75-.75v-.008a.75.75 0 00-.75-.75h-.008a.75.75 0 00-.75.75v.008zM18.75 20.25a.75.75 0 00.75.75h.008a.75.75 0 00.75-.75v-.008a.75.75 0 00-.75-.75h-.008a.75.75 0 00-.75.75v.008z" /></svg>
                            <span class="font-semibold text-gray-700">Mon QR Code</span>
                        </button>
                         <button id="add-friend-btn" class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-center hover:bg-gray-50 transition flex flex-col items-center justify-center">
                            <svg class="w-8 h-8 mx-auto text-purple-500 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.5 21.75c-2.636 0-5.053-.94-6.9-2.515z" /></svg>
                            <span class="font-semibold text-gray-700">Ajouter un ami</span>
                        </button>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">Ma liste d'amis</h3>
                        <ul id="friends-list" class="space-y-3"></ul>
                    </div>
                </div>
            </div>
            <div id="settings-view" class="w-full h-full bg-gray-50 p-6 pt-24 overflow-y-auto hidden">
                 <div class="max-w-md mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Paramètres</h2>
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                         <div class="flex items-center justify-between">
                             <div>
                                 <h3 class="font-semibold text-gray-700">Partager ma position</h3>
                                 <p class="text-sm text-gray-500">Permet à vos amis de voir votre position.</p>
                             </div>
                             <label class="switch">
                                 <input type="checkbox" id="share-location-toggle" checked>
                                 <span class="slider"></span>
                             </label>
                         </div>
                     </div>
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mt-4">
                         <div class="flex items-center justify-between">
                             <div>
                                 <h3 class="font-semibold text-gray-700">Noms des rues & Légende</h3>
                                 <p class="text-sm text-gray-500">Affiche les détails et les crédits.</p>
                             </div>
                             <label class="switch">
                                 <input type="checkbox" id="show-attribution-toggle">
                                 <span class="slider"></span>
                             </label>
                         </div>
                     </div>
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mt-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-semibold text-gray-700">Ajouter par ID</h3>
                                <p class="text-sm text-gray-500">Désactive le scanner pour coller un ID.</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="disable-scanner-toggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="mt-8">
                        <button id="logout-btn" class="w-full bg-red-500 text-white p-3 rounded-lg font-bold hover:bg-red-600">Se déconnecter</button>
                    </div>
                 </div>
            </div>
        </main>
        
        <nav class="bottom-nav">
            <div class="nav-content">
                <button id="friends-btn-container" class="menu-btn-container">
                    <div class="menu-icon"><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"></path></svg></div>
                    <span>Amis</span>
                </button>
                <button id="map-btn-container" class="menu-btn-container">
                    <div class="menu-icon"><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 010-5 2.5 2.5 0 010 5z"></path></svg></div>
                    <span>Carte</span>
                </button>
                <button id="settings-btn-container" class="menu-btn-container">
                    <div class="menu-icon"><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.22,5.72C8.63,5.96,8.1,6.29,7.6,6.67L5.21,5.71C4.99,5.62,4.74,5.69,4.62,5.91L2.7,9.23 c-0.11,0.2-0.06,0.47,0.12,0.61L4.85,11.4c-0.05,0.3-0.07,0.62-0.07,0.94c0,0.32,0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.38,2.91 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17-0.48,0.41l0.38-2.91c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0.01,0.59-0.22l1.92-3.32c0.12-0.2,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path></svg></div>
                    <span>Paramètres</span>
                </button>
            </div>
        </nav>
    </div>

    <script>
    // JS du fichier script.js intégré et corrigé ici
    const { createClient } = supabase;
    const SUPABASE_URL = 'https://yncsoycdtslbdnzaxktm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InluY3NveWNkdHNsYmRuemF4a3RtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxMzY4NjQsImV4cCI6MjA3MjcxMjg2NH0.z8NBjW_XsAUl1VY9l3BljClTobwMxqRNVo3sgTmNug';

    const highAccuracyOptions = { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 };
    const lyceeCenter = [45.96239, 5.34721];

    // --- State Management ---
    const appState = {
        map: null, supabase: null, currentUser: null, userMarker: null, userAccuracyCircle: null,
        friendMarkers: {}, friends: {}, userName: "", isSharing: true, watchId: null,
        html5QrCode: null, geolocationEnabled: false, mapLayers: {}, isScannerDisabled: true,
        realtimeChannel: null, isEditingFriends: false, friendToDelete: null
    };

    // --- UI Elements ---
    const ui = {};

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // Assign all UI elements to the ui object
        Object.assign(ui, {
            loader: document.getElementById('loader'),
            authView: document.getElementById('auth-view'),
            appContainer: document.getElementById('app-container'),
            // Auth Forms
            loginContainer: document.getElementById('login-container'),
            signupContainer: document.getElementById('signup-container'),
            loginForm: document.getElementById('login-form'),
            signupForm: document.getElementById('signup-form'),
            loginStatus: document.getElementById('login-status'),
            signupStatus: document.getElementById('signup-status'),
            showLoginBtn: document.getElementById('show-login-btn'),
            showSignupBtn: document.getElementById('show-signup-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            toggleSignupPasswordBtn: document.getElementById('toggle-signup-password'),
            toggleLoginPasswordBtn: document.getElementById('toggle-login-password'),
            // App Views & Buttons
            views: { map: document.getElementById('map-view'), friends: document.getElementById('friends-view'), settings: document.getElementById('settings-view') },
            buttons: { map: document.getElementById('map-btn-container'), friends: document.getElementById('friends-btn-container'), settings: document.getElementById('settings-btn-container') },
            centerMapBtn: document.getElementById('center-map-btn'),
            editFriendsBtn: document.getElementById('edit-friends-btn'),
            // Modals
            nameModal: document.getElementById('name-input-modal'),
            nameInput: document.getElementById('name-input'),
            saveNameBtn: document.getElementById('save-name-btn'),
            myQrCodeModal: document.getElementById('my-qr-code-modal'),
            qrCodeContainer: document.getElementById('qr-code-container'),
            closeQrCodeModalBtn: document.getElementById('close-qr-code-modal-btn'),
            qrScannerModal: document.getElementById('qr-scanner-modal'),
            qrScannerContainer: document.getElementById('qr-scanner-container'),
            closeScannerModalBtn: document.getElementById('close-scanner-modal-btn'),
            pasteIdModal: document.getElementById('paste-id-modal'),
            pasteIdInput: document.getElementById('paste-id-input'),
            addFriendFromIdBtn: document.getElementById('add-friend-from-id-btn'),
            closePasteIdModalBtn: document.getElementById('close-paste-id-modal-btn'),
            confirmDeleteModal: document.getElementById('confirm-delete-modal'),
            confirmDeleteText: document.getElementById('confirm-delete-text'),
            confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
            cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
            // In-App Elements
            status: document.getElementById('status'),
            friendsList: document.getElementById('friends-list'),
            shareLocationToggle: document.getElementById('share-location-toggle'),
            showAttributionToggle: document.getElementById('show-attribution-toggle'),
            disableScannerToggle: document.getElementById('disable-scanner-toggle'),
            topBanner: document.getElementById('top-banner'),
            myQrCodeBtn: document.getElementById('my-qr-code-btn'),
            addFriendBtn: document.getElementById('add-friend-btn'),
        });
        
        main();
    });
    
    async function main() {
        try {
            initMap();
            setupEventListeners();
            await initSupabase();
        } catch (error) {
            console.error("Fatal initialization error:", error);
            ui.loader.innerHTML = `<div class="text-center p-4"><p class="mt-4 text-gray-700 font-semibold">Erreur d'Initialisation</p><p class="mt-2 text-gray-600">${error.message}</p></div>`;
        }
    }

    const initSupabase = async () => {
        appState.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
        appState.supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                appState.currentUser = null;
                ui.appContainer.classList.add('hidden');
                ui.authView.classList.remove('hidden');
                ui.loader.classList.add('hidden');
                if (appState.realtimeChannel) {
                    appState.supabase.removeChannel(appState.realtimeChannel);
                    appState.realtimeChannel = null;
                }
                stopLocationTracking();
            }
        });
    
        const { data: { session } } = await appState.supabase.auth.getSession();
    
        if (session) {
            appState.currentUser = session.user;
            await loadApp();
        } else {
            ui.loader.classList.add('hidden');
            ui.authView.classList.remove('hidden');
        }
    };
    
    const initMap = () => {
        appState.map = L.map('map', { 
            center: lyceeCenter, 
            zoom: 17, 
            minZoom: 16,
            maxZoom: 18,
            zoomControl: false, 
            attributionControl: true,
        });
        
        appState.mapLayers.noLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO', maxNativeZoom: 19
        });
        appState.mapLayers.withLabels = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap', maxNativeZoom: 19
        });

        appState.mapLayers.noLabels.addTo(appState.map);
        appState.map.attributionControl.setPrefix(false);
    };

    // --- Application Logic ---
    const loadApp = async () => {
        ui.authView.classList.add('hidden');
        ui.loader.classList.remove('hidden');
    
        const { data: profile, error: profileError } = await appState.supabase
            .from('profiles')
            .select('full_name')
            .eq('id', appState.currentUser.id)
            .single();
    
        if (profileError) {
            console.error("Error fetching user profile:", profileError);
            ui.loader.classList.add('hidden');
            handleLogout();
            return showStatus("Erreur de profil, reconnexion requise.", 'error');
        }
    
        const { data: location, error: locationError } = await appState.supabase
            .from('locations')
            .select('is_sharing')
            .eq('user_id', appState.currentUser.id)
            .single();
        
        if (locationError && locationError.code !== 'PGRST116') {
             console.error("Error fetching user location:", locationError);
        }
        
        ui.loader.classList.add('hidden');
        ui.appContainer.classList.remove('hidden');
        
        if (profile && profile.full_name) {
            appState.userName = profile.full_name;
            appState.isSharing = location?.is_sharing ?? true;
            ui.shareLocationToggle.checked = appState.isSharing;
            
            showView('map');
            
            appState.map.whenReady(async () => {
                const mapBounds = L.latLng(lyceeCenter).toBounds(2000); // 2km diameter
                appState.map.setMaxBounds(mapBounds);
    
                await fetchAndDisplayFriends();
                initiateGeolocation();
                listenToFriendLocations();
            });
        } else {
            ui.nameModal.style.display = 'flex';
        }
    };
    
    // --- Event Handlers & User Actions ---
    const handleSignup = async (e) => {
        e.preventDefault();
        const firstname = e.target.elements['signup-firstname'].value.trim();
        const lastname = e.target.elements['signup-lastname'].value.trim();
        const password = e.target.elements['signup-password'].value;

        if (!firstname || !lastname) {
             ui.signupStatus.textContent = "Le prénom et le nom sont requis.";
             ui.signupStatus.className = "text-red-600";
             return;
        }

        const sanitizedFirstname = firstname.toLowerCase().replace(/[^a-z0-9]/g, '');
        const sanitizedLastname = lastname.toLowerCase().replace(/[^a-z0-9]/g, '');
        const email = `${sanitizedFirstname}.${sanitizedLastname}@geolycee.app`;
        
        ui.signupStatus.textContent = "Création du compte...";
        ui.signupStatus.className = "text-blue-600";
        
        const { data, error } = await appState.supabase.auth.signUp({
            email,
            password,
            options: {
                data: {
                    full_name: `${firstname} ${lastname}`
                }
            }
        });
        
        if (error) {
            if (error.message.includes('unique constraint') || error.message.includes('User already registered')) {
                 ui.signupStatus.textContent = "Un utilisateur avec ce nom et prénom existe déjà.";
            } else {
                 ui.signupStatus.textContent = error.message;
            }
            ui.signupStatus.className = "text-red-600";
        } else if (data.session) {
            ui.signupStatus.textContent = "Compte créé avec succès !";
            ui.signupStatus.className = "text-green-600";
            appState.currentUser = data.session.user;
            await loadApp();
        }
    };
    
    const handleLogin = async (e) => {
        e.preventDefault();
        const firstname = e.target.elements['login-firstname'].value.trim();
        const lastname = e.target.elements['login-lastname'].value.trim();
        const password = e.target.elements['login-password'].value;

        const sanitizedFirstname = firstname.toLowerCase().replace(/[^a-z0-9]/g, '');
        const sanitizedLastname = lastname.toLowerCase().replace(/[^a-z0-9]/g, '');
        const email = `${sanitizedFirstname}.${sanitizedLastname}@geolycee.app`;
        
        ui.loginStatus.textContent = "Connexion...";
        ui.loginStatus.className = "text-blue-600";
        
        const { data, error } = await appState.supabase.auth.signInWithPassword({
            email,
            password,
        });

        if (error) {
            ui.loginStatus.textContent = "Nom, prénom ou mot de passe incorrect.";
            ui.loginStatus.className = "text-red-600";
        } else if (data.session) {
            appState.currentUser = data.session.user;
            await loadApp();
        }
    };

    const handleLogout = async () => {
        await appState.supabase.auth.signOut();
    };

    const saveUserName = async () => {
        const name = ui.nameInput.value.trim();
        if (name) {
            appState.userName = name;
            const { error } = await appState.supabase
                .from('profiles')
                .update({ full_name: appState.userName })
                .eq('id', appState.currentUser.id);

            if (error) {
                showStatus("Erreur lors de la sauvegarde du nom.", 'error');
            } else {
                ui.nameModal.style.display = 'none';
                await loadApp();
            }
        } else {
            showStatus("Veuillez entrer un nom.", 'warning');
        }
    };

    // --- Geolocation ---
    const initiateGeolocation = async () => {
        if (!appState.isSharing) {
            return; // Don't start tracking if user has it disabled
        }

        if (!("geolocation" in navigator) || !("permissions" in navigator)) {
            return showPermanentBanner("Géolocalisation non supportée.");
        }

        const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });

        if (permissionStatus.state === 'granted') {
            startLocationTracking();
        } else if (permissionStatus.state === 'prompt') {
            navigator.geolocation.getCurrentPosition(
                () => {
                    appState.geolocationEnabled = true;
                    startLocationTracking();
                },
                (error) => {
                    appState.geolocationEnabled = false;
                },
                highAccuracyOptions
            );
        } else { // 'denied'
            showPermanentBanner("Activez la géolocalisation dans les paramètres du site.");
        }

        permissionStatus.onchange = () => {
             if (permissionStatus.state === 'granted') {
                 if (!appState.watchId) startLocationTracking();
             } else {
                 showPermanentBanner("Partage de position désactivé.");
                 stopLocationTracking();
             }
        };
    };
    
    const handleCenterMapClick = () => {
        if (appState.userMarker) {
            appState.map.setView(appState.userMarker.getLatLng(), 18, { animate: true });
        } else {
            showStatus("Votre position n'est pas encore disponible.", "info");
        }
    };
    
    const startLocationTracking = () => {
        if (appState.watchId) return;
        ui.status.classList.add('hidden'); // No "searching" message needed
        appState.watchId = navigator.geolocation.watchPosition(
            (pos) => {
                updateSupabaseLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude, timestamp: new Date().toISOString() });
                updateUserMarker(pos.coords);
            },
            (err) => {
                showPermanentBanner("Géolocalisation en pause. Revenez à l'app pour réactiver.");
                stopLocationTracking();
            }, 
            highAccuracyOptions
        );
    };

    const stopLocationTracking = async () => {
        if (appState.watchId) {
            navigator.geolocation.clearWatch(appState.watchId);
            appState.watchId = null;
            if (appState.currentUser) {
                await updateSupabaseLocation({ is_sharing: false });
            }
            showStatus("Partage de position arrêté.", 'info');
        }
    };

    const updateSupabaseLocation = async (data) => {
        if (!appState.currentUser) return;
        try {
            await appState.supabase.from('locations').update(data).eq('user_id', appState.currentUser.id);
        } catch (e) {
            showStatus("Erreur de synchronisation.", 'error');
        }
    };

    // --- Map & Markers ---
    const updateUserMarker = (coords) => {
        const { latitude, longitude, accuracy, heading, speed } = coords;
        const latLng = L.latLng(latitude, longitude);

        const distance = latLng.distanceTo(lyceeCenter);
        if (distance > 1000) {
            showPermanentBanner("Vous êtes en dehors de la zone du lycée");
            if(appState.userMarker) {
                appState.map.removeLayer(appState.userMarker);
                appState.map.removeLayer(appState.userAccuracyCircle);
                appState.userMarker = null;
                appState.userAccuracyCircle = null;
            }
            return;
        } else {
            ui.topBanner.classList.add('hidden');
        }
        
        let userIconHtml;
        if (speed && speed > 1 && heading !== null && !isNaN(heading)) {
            userIconHtml = `
                <div class="relative w-8 h-8 flex items-center justify-center" style="transform: rotate(${heading}deg);">
                    <svg class="w-8 h-8 text-blue-600 filter drop-shadow-lg" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
                    </svg>
                </div>`;
        } else {
            userIconHtml = `
            <div class="relative w-6 h-6 flex items-center justify-center">
                <div class="pulse-ring"></div>
                <svg class="w-6 h-6 text-blue-500 filter drop-shadow-lg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Zm0,18a8,8,0,1,1,8-8A8,8,0,0,1,12,20Z"/>
                    <circle cx="12" cy="12" r="5" fill="currentColor"/>
                </svg>
            </div>`;
        }


        const userIcon = L.divIcon({
            className: 'custom-user-icon',
            html: userIconHtml,
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        if (!appState.userMarker) {
            appState.userAccuracyCircle = L.circle(latLng, { radius: accuracy, color: '#3B82F6', fillColor: '#3B82F6', fillOpacity: 0.15, weight: 1 }).addTo(appState.map);
            appState.userMarker = L.marker(latLng, { icon: userIcon, zIndexOffset: 1000 }).addTo(appState.map);
            appState.userMarker.bindTooltip(appState.userName, { permanent: true, direction: 'top', offset: [0, -15], className: 'name-tooltip' }).openTooltip();
            appState.map.setView(latLng, 18);
        } else {
            appState.userMarker.setLatLng(latLng).setIcon(userIcon);
            appState.userAccuracyCircle.setLatLng(latLng).setRadius(accuracy);
            appState.userMarker.setTooltipContent(appState.userName);
        }
    };
    
    // --- Realtime & Friends ---
    const listenToFriendLocations = () => {
        if (appState.realtimeChannel) return;
        appState.realtimeChannel = appState.supabase.channel('public:locations')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'locations' }, (payload) => {
                const updatedLocationData = payload.new;
                if (!updatedLocationData || updatedLocationData.user_id === appState.currentUser.id || !appState.friends[updatedLocationData.user_id]) return;
                
                const friendId = updatedLocationData.user_id;
                appState.friends[friendId] = { ...appState.friends[friendId], ...updatedLocationData };
                
                renderFriendList();
                updateFriendMarker(appState.friends[friendId]);
            }).subscribe();
    };
    
    const updateFriendMarker = (friendData) => {
        const friendId = friendData.user_id;
        const friendName = friendData.name || 'Ami';
        const shouldDisplay = friendData.is_sharing && friendData.lat && friendData.lng;
        
        if (!shouldDisplay || L.latLng(friendData.lat, friendData.lng).distanceTo(lyceeCenter) > 1000) {
            if (appState.friendMarkers[friendId]) {
                appState.map.removeLayer(appState.friendMarkers[friendId]);
                delete appState.friendMarkers[friendId];
            }
            return;
        }

        const friendIcon = L.divIcon({
            className: 'custom-friend-icon',
            html: `<svg class="w-8 h-8 text-purple-700 filter drop-shadow-md" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 010-5 2.5 2.5 0 010 5z"/></svg>`,
            iconSize: [32, 32], iconAnchor: [16, 32]
        });

        if (appState.friendMarkers[friendId]) {
            appState.friendMarkers[friendId].setLatLng([friendData.lat, friendData.lng]).setTooltipContent(friendName);
        } else {
            appState.friendMarkers[friendId] = L.marker([friendData.lat, friendData.lng], { icon: friendIcon })
                .addTo(appState.map).bindTooltip(friendName, { permanent: true, direction: 'top', offset: [0, -35], className: 'name-tooltip' }).openTooltip();
        }
    };

    const addFriend = async (friendId) => {
        if (!friendId) return showStatus("ID invalide.", 'warning');
        if (friendId === appState.currentUser.id) return showStatus("Vous ne pouvez pas vous ajouter.", 'warning');
        
        const { data: friendExists, error: fetchError } = await appState.supabase.from('profiles').select('full_name').eq('id', friendId).single();
        if (fetchError || !friendExists) return showStatus("Utilisateur introuvable.", 'error');

        const { error } = await appState.supabase.rpc('add_friend', { friend_uuid: friendId });
        
        if (error) {
            showStatus("Erreur lors de l'ajout.", 'error');
            console.error(error);
        } else {
            showStatus(`${friendExists.full_name} a été ajouté(e) !`, 'success');
            await fetchAndDisplayFriends();
        }
    };
    
    const removeFriend = async () => {
        const friendId = appState.friendToDelete;
        if (!friendId) return;

        const { error } = await appState.supabase.rpc('remove_friend', { friend_uuid: friendId });

        if (error) {
            showStatus("Erreur lors de la suppression.", 'error');
        } else {
            showStatus("Ami supprimé.", 'success');
            delete appState.friends[friendId];
            if(appState.friendMarkers[friendId]) {
                appState.map.removeLayer(appState.friendMarkers[friendId]);
                delete appState.friendMarkers[friendId];
            }
            renderFriendList();
        }
        ui.confirmDeleteModal.classList.add('hidden');
        appState.friendToDelete = null;
    };


    const fetchAndDisplayFriends = async () => {
        if (!appState.currentUser) return;
        const { data: relations, error: relationsError } = await appState.supabase.from('friends').select('friend_id').eq('user_id', appState.currentUser.id);
        if (relationsError || !relations) return;
    
        const friendIds = relations.map(r => r.friend_id);
    
        Object.values(appState.friendMarkers).forEach(marker => appState.map.removeLayer(marker));
        appState.friendMarkers = {};
        
        if (friendIds.length === 0) {
            appState.friends = {};
            return renderFriendList();
        }
        
        const { data: friendsProfiles, error: profilesError } = await appState.supabase
            .from('profiles')
            .select(`id, full_name`)
            .in('id', friendIds);
        
        if (profilesError || !friendsProfiles) {
            console.error("Error fetching friends profiles:", profilesError);
            return;
        }
        
        const { data: friendsLocations, error: locationsError } = await appState.supabase
            .from('locations')
            .select(`user_id, lat, lng, is_sharing`)
            .in('user_id', friendIds);
            
        if (locationsError) {
            console.error("Error fetching friends locations:", locationsError);
        }
        
        const locationsMap = new Map();
        if (friendsLocations) {
            friendsLocations.forEach(loc => locationsMap.set(loc.user_id, loc));
        }
        
        appState.friends = {};
        friendsProfiles.forEach(profile => {
            const locationInfo = locationsMap.get(profile.id);
            const friendObject = {
                user_id: profile.id,
                name: profile.full_name,
                lat: locationInfo?.lat,
                lng: locationInfo?.lng,
                is_sharing: locationInfo?.is_sharing ?? true
            };
            appState.friends[profile.id] = friendObject;
            updateFriendMarker(friendObject);
        });
        renderFriendList();
    };

    // --- UI Rendering & Helpers ---
    const getLocationStatus = (lat, lng) => {
        if (!lat || !lng) return "Position inconnue";
        const point = L.latLng(lat, lng);
        const distance = point.distanceTo(lyceeCenter);
        
        if (distance > 1000) return "En dehors de la zone";

        const lyceeZone = L.circle(lyceeCenter, { radius: 250 });
        if (lyceeZone.getBounds().contains(point)) return "Au lycée";

        return "Proche du lycée";
    };

    const renderFriendList = () => {
        ui.friendsList.innerHTML = '';
        const friendIds = Object.keys(appState.friends);
        if (friendIds.length === 0) {
            ui.friendsList.innerHTML = `<li class="text-center text-gray-500 py-4">Ajoutez votre premier ami.</li>`;
            return;
        }
        friendIds.forEach(id => {
            const friend = appState.friends[id];
            const status = friend.is_sharing === false ? "Partage désactivé" : getLocationStatus(friend.lat, friend.lng);
            const li = document.createElement('li');
            li.className = 'bg-white p-3 rounded-lg shadow-sm flex items-center justify-between';
            
            let actionButton;
            if (appState.isEditingFriends) {
                actionButton = `<button data-friend-id="${id}" data-friend-name="${friend.name}" class="remove-friend-btn text-red-500 hover:text-red-700">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                 </button>`;
            } else {
                actionButton = `<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>`;
            }

            li.innerHTML = `
                <div class="flex-grow cursor-pointer" data-friend-id="${id}">
                    <span class="font-medium text-gray-800">${friend.name || 'Ami'}</span>
                    <p class="text-sm text-gray-500 mt-1">${status}</p>
                </div>
                ${actionButton}`;
            
            ui.friendsList.appendChild(li);
        });
        
        // Add event listeners after rendering
        ui.friendsList.querySelectorAll('[data-friend-id]').forEach(el => {
            if(el.classList.contains('remove-friend-btn')) {
                el.addEventListener('click', (e) => {
                    appState.friendToDelete = e.currentTarget.dataset.friendId;
                    ui.confirmDeleteText.textContent = `Êtes-vous sûr de vouloir supprimer ${e.currentTarget.dataset.friendName} ?`;
                    ui.confirmDeleteModal.classList.remove('hidden');
                });
            } else if (!appState.isEditingFriends) {
                el.addEventListener('click', (e) => centerOnFriend(e.currentTarget.dataset.friendId));
            }
        });
    };

    const centerOnFriend = (friendId) => {
        const friend = appState.friends[friendId];
        if (friend && friend.is_sharing !== false && appState.friendMarkers[friendId]) {
            showView('map');
            appState.map.setView(appState.friendMarkers[friendId].getLatLng(), 18, { animate: true, pan: { duration: 1 } });
            showStatus(`Centrage sur ${friend.name}`, 'info');
        } else {
            showStatus(`${friend.name || 'Cet ami'} ne partage pas sa position.`, 'warning');
        }
    };

    const showMyQrCode = () => {
        if (!appState.currentUser) return;
        ui.qrCodeContainer.innerHTML = '';
        const qr = qrcode(0, 'L');
        qr.addData(appState.currentUser.id);
        qr.make();
        ui.qrCodeContainer.innerHTML = qr.createImgTag(6, 8);
        ui.myQrCodeModal.classList.remove('hidden');
    };

    const startQrScanner = async () => {
        ui.qrScannerModal.classList.remove('hidden');
        if (!appState.html5QrCode) {
             appState.html5QrCode = new Html5Qrcode("qr-scanner-container", { formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE] });
        }
        try {
            await appState.html5QrCode.start(
                { facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => { stopQrScanner(); addFriend(decodedText); },
                () => {}
            );
        } catch (err) {
            showStatus("Impossible de démarrer la caméra.", "error");
            stopQrScanner();
        }
    };

    const stopQrScanner = () => {
        if (appState.html5QrCode && appState.html5QrCode.isScanning) {
            appState.html5QrCode.stop().catch(err => console.error("Scanner not stopped correctly.", err));
        }
        ui.qrScannerModal.classList.add('hidden');
    };
    
    // --- Event Listeners Setup ---
    const setupEventListeners = () => {
        // Auth
        ui.signupForm.addEventListener('submit', handleSignup);
        ui.loginForm.addEventListener('submit', handleLogin);
        ui.logoutBtn.addEventListener('click', handleLogout);
        ui.showLoginBtn.addEventListener('click', () => {
            ui.signupContainer.classList.add('hidden');
            ui.loginContainer.classList.remove('hidden');
        });
        ui.showSignupBtn.addEventListener('click', () => {
            ui.loginContainer.classList.add('hidden');
            ui.signupContainer.classList.remove('hidden');
        });

        const setupPasswordToggle = (toggleBtn, passwordInput) => {
            const eyeIcon = toggleBtn.querySelector('.eye-icon');
            const eyeSlashedIcon = toggleBtn.querySelector('.eye-slashed-icon');

            toggleBtn.addEventListener('click', () => {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeIcon.classList.add('hidden');
                    eyeSlashedIcon.classList.remove('hidden');
                } else {
                    passwordInput.type = 'password';
                    eyeIcon.classList.remove('hidden');
                    eyeSlashedIcon.classList.add('hidden');
                }
            });
        };
        setupPasswordToggle(ui.toggleSignupPasswordBtn, document.getElementById('signup-password'));
        setupPasswordToggle(ui.toggleLoginPasswordBtn, document.getElementById('login-password'));

        // App
        ui.saveNameBtn.addEventListener('click', saveUserName);
        ui.buttons.friends.addEventListener('click', () => showView('friends'));
        ui.buttons.settings.addEventListener('click', () => showView('settings'));
        ui.buttons.map.addEventListener('click', () => {
            if (ui.views.map.classList.contains('hidden')) showView('map');
            else if(appState.userMarker) appState.map.setView(appState.userMarker.getLatLng(), 18);
            else appState.map.setView(lyceeCenter, 18);
        });
        ui.centerMapBtn.addEventListener('click', handleCenterMapClick);
        ui.editFriendsBtn.addEventListener('click', () => {
            appState.isEditingFriends = !appState.isEditingFriends;
            ui.editFriendsBtn.textContent = appState.isEditingFriends ? 'Terminer' : 'Modifier';
            renderFriendList();
        });

        // Settings
        ui.shareLocationToggle.addEventListener('change', (e) => {
            appState.isSharing = e.target.checked;
            updateSupabaseLocation({ is_sharing: appState.isSharing });
            if(appState.isSharing) {
                showStatus("Partage activé. Cliquez sur la cible pour mettre à jour.", "info");
            } else {
                stopLocationTracking();
            }
        });
        ui.showAttributionToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                appState.map.removeLayer(appState.mapLayers.noLabels);
                appState.map.addLayer(appState.mapLayers.withLabels);
            } else {
                appState.map.removeLayer(appState.mapLayers.withLabels);
                appState.map.addLayer(appState.mapLayers.noLabels);
            }
        });
        ui.disableScannerToggle.addEventListener('change', (e) => {
            appState.isScannerDisabled = e.target.checked;
        });

        // Modals
        ui.myQrCodeBtn.addEventListener('click', showMyQrCode);
        ui.closeQrCodeModalBtn.addEventListener('click', () => ui.myQrCodeModal.classList.add('hidden'));
        ui.addFriendBtn.addEventListener('click', () => {
            if (appState.isScannerDisabled) {
                ui.pasteIdModal.classList.remove('hidden');
            } else {
                startQrScanner();
            }
        });
        ui.closePasteIdModalBtn.addEventListener('click', () => ui.pasteIdModal.classList.add('hidden'));
        ui.addFriendFromIdBtn.addEventListener('click', () => {
            const friendId = ui.pasteIdInput.value.trim();
            if (friendId) {
                addFriend(friendId);
                ui.pasteIdInput.value = '';
                ui.pasteIdModal.classList.add('hidden');
            } else {
                showStatus("Veuillez entrer un ID.", 'warning');
            }
        });
        ui.closeScannerModalBtn.addEventListener('click', stopQrScanner);
        ui.confirmDeleteBtn.addEventListener('click', removeFriend);
        ui.cancelDeleteBtn.addEventListener('click', () => {
            ui.confirmDeleteModal.classList.add('hidden');
            appState.friendToDelete = null;
        });
        
        // Listen for visibility change to re-start geolocation
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && appState.isSharing && !appState.watchId && appState.currentUser) {
                startLocationTracking();
            }
        });
    };
    
    const showView = (viewName) => {
        Object.values(ui.views).forEach(v => v.classList.add('hidden'));
        ui.views[viewName].classList.remove('hidden');
        document.querySelectorAll('.menu-btn-container').forEach(el => el.classList.remove('active-menu'));
        ui.buttons[viewName].classList.add('active-menu');
        if (viewName === 'map') appState.map.invalidateSize();
        if (viewName === 'friends') {
            appState.isEditingFriends = false; // Reset edit mode when switching to friends view
            ui.editFriendsBtn.textContent = 'Modifier';
            fetchAndDisplayFriends();
        }
    };

    const showStatus = (message, type = 'info') => {
        const colors = { info: 'bg-blue-100 text-blue-800', success: 'bg-green-100 text-green-800', warning: 'bg-yellow-100 text-yellow-800', error: 'bg-red-100 text-red-800' };
        ui.status.textContent = message;
        ui.status.className = `fixed top-5 left-1/2 -translate-x-1/2 text-center text-sm font-medium p-3 rounded-xl shadow-lg transition-all duration-300 z-[1001] ${colors[type]}`;
        ui.status.classList.remove('hidden');
        setTimeout(() => ui.status.classList.add('hidden'), 3000);
    };

    const showPermanentBanner = (message) => {
        ui.topBanner.textContent = message;
        ui.topBanner.classList.remove('hidden');
    };
    </script>
</body>
</html>

